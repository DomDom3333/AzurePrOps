<Window
    Background="{DynamicResource BackgroundBrush}"
    Icon="/Assets/avalonia-logo.ico"
    Title="AzurePrOps"
    d:DesignHeight="600"
    d:DesignWidth="1200"
    mc:Ignorable="d"
    x:Class="AzurePrOps.Views.MainWindow"
    x:DataType="vm:MainWindowViewModel"
    x:Name="MainWindowRoot"
    xmlns="https://github.com/avaloniaui"
    xmlns:converters="using:AzurePrOps.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:model="using:AzurePrOps.AzureConnection.Models"
    xmlns:vm="using:AzurePrOps.ViewModels"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <Design.DataContext>
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <Window.Resources>
        <converters:StatusToBrushConverter x:Key="StatusToBrushConverter" />
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Header with improved layout  -->
        <Border
            Background="{DynamicResource SurfaceBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="0,0,0,1"
            Padding="24,16">
            <Grid ColumnDefinitions="*,Auto,Auto">
                <StackPanel Orientation="Horizontal" Spacing="16">
                    <TextBlock
                        FontSize="24"
                        FontWeight="Bold"
                        Text="Pull Requests"
                        VerticalAlignment="Center" />
                    <Border
                        Background="{DynamicResource AccentBrush}"
                        CornerRadius="12"
                        Padding="8,2">
                        <TextBlock
                            FontSize="10"
                            FontWeight="Medium"
                            Foreground="White"
                            Text="{Binding ActiveFiltersCount}" />
                    </Border>
                </StackPanel>

                <!--  Quick Stats  -->
                <StackPanel
                    Grid.Column="1"
                    Margin="0,0,16,0"
                    Orientation="Horizontal"
                    Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock
                            FontSize="12"
                            Foreground="{DynamicResource TextSecondaryBrush}"
                            Text="Active:" />
                        <TextBlock FontWeight="SemiBold" Text="{Binding ActivePRCount}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock
                            FontSize="12"
                            Foreground="{DynamicResource TextSecondaryBrush}"
                            Text="Needs Review:" />
                        <TextBlock FontWeight="SemiBold" Text="{Binding MyReviewPendingCount}" />
                    </StackPanel>
                </StackPanel>

                <StackPanel
                    Grid.Column="2"
                    Orientation="Horizontal"
                    Spacing="12">
                    <Button
                        Classes="PrimaryButton"
                        Command="{Binding RefreshCommand}"
                        Content="Refresh" />
                    <Button
                        Classes="SecondaryButton"
                        Command="{Binding OpenSettingsCommand}"
                        Content="Settings" />
                </StackPanel>
            </Grid>
        </Border>

        <!--  Main Content with improved layout  -->
        <Grid
            ColumnDefinitions="320,*"
            Grid.Row="1"
            Margin="24,20">

            <!--  Enhanced Sidebar with collapsible sections  -->
            <ScrollViewer
                Grid.Column="0"
                Margin="0,0,16,0"
                VerticalScrollBarVisibility="Auto">
                <StackPanel Spacing="16">

                    <!--  Global Search - Top priority  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="8">
                            <TextBlock
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Quick Search" />
                            <TextBox
                                FontSize="14"
                                Text="{Binding GlobalSearchText}"
                                Watermark="Search titles, creators, branches..." />
                            <TextBlock
                                FontSize="10"
                                Foreground="{DynamicResource TextSecondaryBrush}"
                                Text="Searches across titles, creators, and branch names"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Quick Action Filters  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Quick Filters" />

                            <StackPanel Spacing="8">
                                <CheckBox
                                    Content="My Pull Requests"
                                    FontWeight="Medium"
                                    IsChecked="{Binding ShowMyPullRequestsOnly}" />
                                <CheckBox
                                    Content="Needs My Review"
                                    FontWeight="Medium"
                                    IsChecked="{Binding ShowNeedsMyReviewOnly}" />
                                <CheckBox
                                    Content="Assigned to Me"
                                    FontWeight="Medium"
                                    IsChecked="{Binding ShowAssignedToMeOnly}" />
                                <CheckBox
                                    Content="Exclude My PRs"
                                    FontWeight="Medium"
                                    IsChecked="{Binding ExcludeMyPullRequests}"
                                    ToolTip.Tip="Hide PRs created by me to focus on reviews" />
                            </StackPanel>

                            <!--  Quick Action Buttons  -->
                            <Grid ColumnDefinitions="*,*">
                                <Button
                                    Classes="SecondaryButton"
                                    Command="{Binding ApplyQuickFilterMyPRsCommand}"
                                    Content="My PRs"
                                    FontSize="11"
                                    Grid.Column="0"
                                    Margin="0,0,4,0"
                                    Padding="8,4" />
                                <Button
                                    Classes="SecondaryButton"
                                    Command="{Binding ApplyQuickFilterNeedsReviewCommand}"
                                    Content="Need Review"
                                    FontSize="11"
                                    Grid.Column="1"
                                    Margin="4,0,0,0"
                                    Padding="8,4" />
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!--  Workflow Presets - Prominently featured  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Workflow Presets" />
                            <ComboBox
                                FontSize="13"
                                ItemsSource="{Binding WorkflowPresets}"
                                SelectedItem="{Binding SelectedWorkflowPreset}"
                                ToolTip.Tip="{Binding SelectedWorkflowPresetTooltip}" />
                            <TextBlock
                                FontSize="10"
                                Foreground="{DynamicResource TextSecondaryBrush}"
                                Text="{Binding SelectedWorkflowPresetTooltip}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Status & Priority Filters  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Status &amp; Priority" />

                            <StackPanel Spacing="8">
                                <StackPanel Spacing="4">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="Medium"
                                        Text="Status" />
                                    <ComboBox
                                        ItemsSource="{Binding AvailableStatuses}"
                                        PlaceholderText="Select Status..."
                                        SelectedItem="{Binding StatusFilter, Mode=TwoWay}" />
                                </StackPanel>

                                <StackPanel Spacing="4">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="Medium"
                                        Text="My Vote" />
                                    <ComboBox ItemsSource="{Binding AvailableReviewerVotes}" SelectedItem="{Binding ReviewerVoteFilter}" />
                                </StackPanel>

                                <StackPanel Spacing="4">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="Medium"
                                        Text="Draft Status" />
                                    <ComboBox ItemsSource="{Binding DraftFilterOptions}" SelectedItem="{Binding DraftFilter}" />
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Date Range Filters  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Date Range" />

                            <StackPanel Spacing="8">
                                <StackPanel Spacing="4">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="Medium"
                                        Text="Quick Range" />
                                    <ComboBox ItemsSource="{Binding DateRangePresets}" SelectedItem="{Binding SelectedDateRangePreset}" />
                                </StackPanel>

                                <StackPanel IsVisible="{Binding SelectedDateRangePreset, Converter={x:Static StringConverters.IsNullOrEmpty}}" Spacing="4">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="Medium"
                                        Text="Custom Range" />
                                    <StackPanel Spacing="4">
                                        <DatePicker SelectedDate="{Binding CreatedAfter}" />
                                        <DatePicker SelectedDate="{Binding CreatedBefore}" />
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Text Filters - Collapsible  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Text Filters" />

                            <StackPanel Spacing="8">
                                <AutoCompleteBox
                                    ItemsSource="{Binding AvailableCreators}"
                                    Text="{Binding CreatorFilter}"
                                    Watermark="Creator name..." />
                                <AutoCompleteBox
                                    ItemsSource="{Binding AvailableReviewers}"
                                    Text="{Binding ReviewerFilter}"
                                    Watermark="Reviewer name..." />
                                <TextBox Text="{Binding TitleFilter}" Watermark="Title contains..." />
                                <AutoCompleteBox
                                    ItemsSource="{Binding AvailableSourceBranches}"
                                    Text="{Binding SourceBranchFilter}"
                                    Watermark="Source branch..." />
                                <AutoCompleteBox
                                    ItemsSource="{Binding AvailableTargetBranches}"
                                    Text="{Binding TargetBranchFilter}"
                                    Watermark="Target branch..." />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Group Filtering - Consolidated  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Group Filters" />

                            <!--  Group Membership Filter  -->
                            <StackPanel Spacing="8">
                                <CheckBox
                                    Content="Filter by Group Membership"
                                    FontWeight="Medium"
                                    IsChecked="{Binding EnableGroupFiltering}"
                                    ToolTip.Tip="Show only PRs where selected groups are reviewers" />

                                <StackPanel IsVisible="{Binding EnableGroupFiltering}" Spacing="4">
                                    <TextBlock
                                        FontSize="10"
                                        Foreground="{DynamicResource TextSecondaryBrush}"
                                        Text="{Binding SelectedGroupsText}"
                                        TextWrapping="Wrap" />
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Button
                                            Classes="SecondaryButton"
                                            Command="{Binding SelectGroupsCommand}"
                                            Content="Select Groups"
                                            FontSize="11"
                                            Grid.Column="0"
                                            Margin="0,0,4,0" />
                                        <Button
                                            Classes="SecondaryButton"
                                            Command="{Binding ClearGroupSelectionCommand}"
                                            Content="✕"
                                            FontSize="11"
                                            Grid.Column="1"
                                            Width="24" />
                                    </Grid>
                                </StackPanel>
                            </StackPanel>

                            <!--  Groups Awaiting Vote Filter  -->
                            <StackPanel Spacing="8">
                                <CheckBox
                                    Content="Groups Awaiting Vote"
                                    FontWeight="Medium"
                                    IsChecked="{Binding EnableGroupsWithoutVoteFilter}"
                                    ToolTip.Tip="Show PRs where selected groups haven't voted yet" />

                                <StackPanel IsVisible="{Binding EnableGroupsWithoutVoteFilter}" Spacing="4">
                                    <TextBlock
                                        FontSize="10"
                                        Foreground="{DynamicResource TextSecondaryBrush}"
                                        Text="{Binding SelectedGroupsWithoutVoteText}"
                                        TextWrapping="Wrap" />
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Button
                                            Classes="SecondaryButton"
                                            Command="{Binding SelectGroupsWithoutVoteCommand}"
                                            Content="Select Groups"
                                            FontSize="11"
                                            Grid.Column="0"
                                            Margin="0,0,4,0" />
                                        <Button
                                            Classes="SecondaryButton"
                                            Command="{Binding ClearGroupsWithoutVoteSelectionCommand}"
                                            Content="✕"
                                            FontSize="11"
                                            Grid.Column="1"
                                            Width="24" />
                                    </Grid>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Sorting  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="12">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock
                                    FontSize="16"
                                    FontWeight="SemiBold"
                                    Text="Sorting" />
                                <Button
                                    Classes="SecondaryButton"
                                    Command="{Binding ResetSortingCommand}"
                                    Content="Reset"
                                    FontSize="10"
                                    Padding="4,2" />
                            </StackPanel>

                            <StackPanel Spacing="8">
                                <StackPanel Spacing="4">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="Medium"
                                        Text="Sort Preset" />
                                    <ComboBox
                                        ItemsSource="{Binding SortPresets}"
                                        SelectedItem="{Binding SelectedSortPreset}"
                                        ToolTip.Tip="{Binding SelectedSortPresetTooltip}" />
                                </StackPanel>

                                <TextBlock
                                    FontSize="10"
                                    Foreground="{DynamicResource TextSecondaryBrush}"
                                    Text="{Binding SelectedSortPresetTooltip}"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Filter Management  -->
                    <Border Classes="Card">
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Saved Views" />

                            <StackPanel Spacing="8">
                                <ComboBox ItemsSource="{Binding FilterViews}" SelectedItem="{Binding SelectedFilterView}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Name}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>

                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBox
                                        Grid.Column="0"
                                        Margin="0,0,4,0"
                                        Text="{Binding NewViewName}"
                                        Watermark="View name..." />
                                    <Button
                                        Classes="SecondaryButton"
                                        Command="{Binding SaveViewCommand}"
                                        Content="Save"
                                        Grid.Column="1"
                                        Width="50" />
                                </Grid>
                            </StackPanel>

                            <!--  Reset Actions  -->
                            <StackPanel Spacing="4">
                                <TextBlock
                                    FontSize="12"
                                    FontWeight="Medium"
                                    Text="Reset Options" />
                                <Grid ColumnDefinitions="*,*">
                                    <Button
                                        Classes="SecondaryButton"
                                        Command="{Binding ResetFiltersCommand}"
                                        Content="Reset Filters"
                                        FontSize="10"
                                        Grid.Column="0"
                                        Margin="0,0,2,0"
                                        Padding="4,2" />
                                    <Button
                                        Classes="SecondaryButton"
                                        Command="{Binding ClearAllFiltersCommand}"
                                        Content="Clear All"
                                        FontSize="10"
                                        Grid.Column="1"
                                        Margin="2,0,0,0"
                                        Padding="4,2" />
                                </Grid>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Filter Summary  -->
                    <Border Classes="Card" IsVisible="{Binding HasActiveFilters}">
                        <StackPanel Spacing="8">
                            <TextBlock
                                FontSize="14"
                                FontWeight="SemiBold"
                                Text="Active Filters" />
                            <TextBlock
                                FontSize="11"
                                Foreground="{DynamicResource TextSecondaryBrush}"
                                Text="{Binding FilterSummary}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Quick Comment for selected PR  -->
                    <Border Classes="Card" IsVisible="{Binding SelectedPullRequest, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="14"
                                FontWeight="SemiBold"
                                Text="Quick Comment" />
                            <TextBox
                                AcceptsReturn="True"
                                Height="80"
                                Text="{Binding NewCommentText}"
                                TextWrapping="Wrap"
                                Watermark="Add a comment..." />
                            <Button
                                Classes="PrimaryButton"
                                Command="{Binding PostCommentCommand}"
                                Content="Post Comment" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <!--  Main Content Area  -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Results Summary  -->
                <Border
                    Classes="Card"
                    Grid.Row="0"
                    Margin="0,0,0,16">
                    <Grid ColumnDefinitions="*,Auto">
                        <StackPanel Orientation="Horizontal" Spacing="16">
                            <TextBlock FontWeight="SemiBold" Text="{Binding PullRequests.Count, StringFormat='Showing {0} pull requests'}" />
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="{Binding FilterSummary}" />
                        </StackPanel>

                        <StackPanel
                            Grid.Column="1"
                            Orientation="Horizontal"
                            Spacing="8">
                            <Button
                                Classes="SecondaryButton"
                                Content="Export"
                                FontSize="11"
                                Padding="8,4" />
                        </StackPanel>
                    </Grid>
                </Border>

                <!--  Pull Requests List  -->
                <ListBox
                    Grid.Row="1"
                    ItemsSource="{Binding PullRequests}"
                    SelectedItem="{Binding SelectedPullRequest}">
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="model:PullRequestInfo">
                            <Border Classes="Card" Margin="8">
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel
                                        Grid.Column="0"
                                        Margin="0,0,16,0"
                                        Spacing="8">
                                        <Grid ColumnDefinitions="*,Auto,Auto">
                                            <TextBlock
                                                FontSize="16"
                                                FontWeight="SemiBold"
                                                Grid.Column="0"
                                                MaxLines="2"
                                                Text="{Binding Title}"
                                                TextTrimming="CharacterEllipsis"
                                                TextWrapping="Wrap"
                                                VerticalAlignment="Top" />
                                            <Border
                                                Background="{Binding Status, Converter={StaticResource StatusToBrushConverter}}"
                                                CornerRadius="4"
                                                Grid.Column="1"
                                                Height="20"
                                                Margin="8,0,0,0"
                                                Padding="6,2"
                                                VerticalAlignment="Top">
                                                <TextBlock
                                                    FontSize="10"
                                                    FontWeight="Medium"
                                                    Foreground="White"
                                                    Text="{Binding Status}"
                                                    VerticalAlignment="Center" />
                                            </Border>
                                            <Border
                                                Background="{DynamicResource AccentBrush}"
                                                CornerRadius="4"
                                                Grid.Column="2"
                                                Height="20"
                                                IsVisible="{Binding IsDraft}"
                                                Margin="4,0,0,0"
                                                Padding="6,2"
                                                VerticalAlignment="Top">
                                                <TextBlock
                                                    FontSize="10"
                                                    FontWeight="Medium"
                                                    Foreground="White"
                                                    Text="DRAFT"
                                                    VerticalAlignment="Center" />
                                            </Border>
                                        </Grid>

                                        <StackPanel Orientation="Horizontal" Spacing="16">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="By:" />
                                                <TextBlock FontWeight="Medium" Text="{Binding Creator}" />
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="Created:" />
                                                <TextBlock Text="{Binding Created, StringFormat='{}{0:MMM dd, yyyy}'}" />
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="ID:" />
                                                <TextBlock Text="{Binding Id}" />
                                            </StackPanel>
                                        </StackPanel>

                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock
                                                FontFamily="Consolas"
                                                FontSize="11"
                                                Text="{Binding SourceBranch}" />
                                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" Text="→" />
                                            <TextBlock
                                                FontFamily="Consolas"
                                                FontSize="11"
                                                Text="{Binding TargetBranch}" />
                                        </StackPanel>
                                    </StackPanel>

                                    <StackPanel
                                        Grid.Column="1"
                                        HorizontalAlignment="Right"
                                        Spacing="8"
                                        VerticalAlignment="Top">
                                        <Button
                                            Classes="PrimaryButton"
                                            Command="{ReflectionBinding DataContext.ViewDetailsCommand,
                                                                        ElementName=MainWindowRoot}"
                                            CommandParameter="{Binding}"
                                            Content="View Details"
                                            FontSize="11"
                                            Padding="12,6" />
                                        <Button
                                            Classes="SecondaryButton"
                                            Command="{ReflectionBinding DataContext.OpenInBrowserCommand,
                                                                        ElementName=MainWindowRoot}"
                                            CommandParameter="{Binding}"
                                            Content="Open in Browser"
                                            FontSize="11"
                                            Padding="12,6" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Grid>
    </Grid>
</Window>
